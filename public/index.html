<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DUST_IO Stars Shop</title>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Rubik:wght@600&family=Anton&display=swap"
    rel="stylesheet"
  />

  <!-- TON Connect UI SDK -->
  <script
    src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"
    defer
  ></script>

  <style>
    /* === VARIABLES & GLOBAL RESET === */
    :root {
      --primary:    #1A2026;
      --header:     #212932;
      --card:       #242E38;
      --blue:       #0096F3;
      --white:      #ffffff;
      --gray:       #6c7380;
      --lightgray:  #a3a9b4;
      --error:      #e74c3c;
      --disabled:   #0096F3;
    }
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Rubik', sans-serif;
      background: var(--primary);
      color: var(--white);
      line-height: 1.5;
    }

    /* Hide number spinner */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    /* === HEADER === */
    header {
      background: var(--header);
      padding: 12px;
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-title img {
      width: 50px;
      height: 50px;
    }
    .logo-title h1 {
      font-family: 'Anton', sans-serif;
      font-size: 28px;
      letter-spacing: 1px;
    }
    .ton-connect {
      background: var(--blue);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      color: var(--white);
      font-weight: bold;
      cursor: pointer;
    }
    .nav {
      margin-top: 12px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    .nav a {
      color: var(--white);
      text-decoration: none;
      padding-bottom: 4px;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    .nav a.active {
      border-color: var(--blue);
    }

    /* === CONTAINER & INTRO === */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px;
    }
    .intro {
      text-align: center;
      margin-bottom: 24px;
    }
    .intro h2 {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 26px;
    }
    .intro p {
      margin-top: 8px;
      color: var(--lightgray);
      font-size: 15px;
    }

    /* === FORM ELEMENTS === */
    label, .section-title {
      display: block;
      margin-top: 20px;
      margin-bottom: 8px;
      color: var(--lightgray);
      font-size: 14px;
    }
    .input-wrapper {
      position: relative;
      margin-bottom: 12px;
    }
    .input-wrapper img {
      position: absolute;
      top: 50%;
      left: 12px;
      width: 24px;
      height: 24px;
      transform: translateY(-50%);
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 12px 44px;
      background: var(--card);
      border: none;
      border-radius: 8px;
      color: var(--white);
      font-size: 16px;
      outline: none;
    }
    .clear-icon {
      position: absolute;
      top: 50%;
      right: 12px;
      font-size: 18px;
      color: var(--lightgray);
      cursor: pointer;
      transform: translateY(-50%);
      display: none;
    }
    input:not(:placeholder-shown) ~ .clear-icon {
      display: block;
    }
    .error-text {
      color: var(--error);
      font-size: 13px;
      margin-top: 4px;
    }

    /* Recipient photo & name */
    .recipient-photo {
      position: absolute;
      top: 50%; left: 40px;
      width: 24px; height: 24px;
      border-radius: 50%;
      transform: translateY(-50%);
      display: none;
    }
    .recipient-name {
      position: absolute;
      top: 50%; left: 72px;
      transform: translateY(-50%);
      font-size: 14px;
      display: none;
    }

    /* Inline amount price */
    .price-inline {
      position: absolute;
      top: 50%; right: 44px;
      transform: translateY(-50%);
      display: none;
      align-items: center;
      gap: 4px;
    }
    .price-inline .ton-logo {
      width: 16px; height: 16px;
    }

    /* === PACKAGES === */
    .package-list {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .package {
      background: var(--card);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .package.selected {
      border-color: var(--blue);
    }
    .package .left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .checkbox {
      width: 20px; height: 20px;
      border: 2px solid var(--gray);
      border-radius: 50%;
      position: relative;
    }
    .package.selected .checkbox {
      border-color: var(--blue);
    }
    .checkbox::after {
      content: '';
      position: absolute;
      top: 3px; left: 3px;
      width: 10px; height: 10px;
      background: var(--blue);
      border-radius: 50%;
      display: none;
    }
    .package.selected .checkbox::after {
      display: block;
    }
    .stars img {
      width: 20px; height: 20px;
      margin-left: -24px;
      filter: drop-shadow(1px 0 2px rgba(0,0,0,0.5));
    }
    .stars img:first-child {
      margin-left: 0;
    }
    .price img.ton-logo {
      width: 20px; height: 20px;
    }

    /* === BUY BUTTON & HISTORY === */
    .btn-buy {
      margin-top: 24px;
      width: 100%;
      height: 50px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: not-allowed;
      background: var(--disabled);
      color: #b3b3b3;
    }
    .btn-buy.enabled {
      background: var(--blue);
      color: var(--white);
      cursor: pointer;
    }
    .link-history {
      display: block;
      text-align: center;
      margin-top: 16px;
      color: var(--blue);
      text-decoration: none;
      font-size: 14px;
    }

    /* === SHOW MORE OPTIONS === */
    .show-options {
      margin-top: 20px;
      padding: 16px;
      background: var(--card);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      color: var(--blue);
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="logo-title">
        <img src="logo.png" alt="Logo"/>
        <h1>DUST_IO</h1>
      </div>
      <button id="ton-connect" class="ton-connect">Connect Wallet</button>
    </div>
    <nav class="nav">
      <a href="#" class="active">Stars</a>
      <a href="#">Support</a>
      <a href="#">Terms</a>
    </nav>
  </header>

  <main class="container">
    <section class="intro">
      <h2>
        Buy Telegram Stars
        <img src="star.svg" alt="star" width="26"/>
      </h2>
      <p>Top up Stars balance for yourself or your friends.</p>
    </section>

    <!-- Recipient -->
    <label for="username">Recipient</label>
    <div class="input-wrapper">
      <img src="Search.svg" alt="search"/>
      <input
        type="text"
        id="username"
        placeholder="Telegram username"
      />
      <img id="recipient-photo" class="recipient-photo" alt="photo"/>
      <span id="recipient-name" class="recipient-name"></span>
      <div class="clear-icon" onclick="clearInput('username')">×</div>
    </div>
    <div id="error-msg" class="error-text"></div>

    <!-- Quantity -->
    <label for="amount">Quantity</label>
    <div class="input-wrapper">
      <img src="star.svg" alt="star"/>
      <input
        type="number"
        id="amount"
        placeholder="50 – 1 000 000"
      />
      <div id="amount-price-container" class="price-inline">
        <img src="ton.svg" class="ton-logo" alt="TON"/>
        <span id="amount-price"></span>
      </div>
      <div class="clear-icon" onclick="clearInput('amount')">×</div>
    </div>

    <!-- Packages -->
    <p class="section-title">Or select a package</p>
    <div id="packages" class="package-list"></div>
    <div id="toggleOptions" class="show-options">
      Show More Options ▼
    </div>

    <!-- Buy & History -->
    <button id="buyBtn" class="btn-buy">Buy Stars</button>
    <a href="#" class="link-history">View Transaction History</a>
  </main>

  <script>
    // === TON Connect UI ===
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: '/tonconnect-manifest.json',
      buttonRootId: 'ton-connect'
    });
    let isWalletConnected = false;
    tonConnectUI.onStatusChange(() => {
      isWalletConnected = tonConnectUI.connected;
      updateBuyBtn();
    });

    // === ELEMENTS & STATE ===
    const usernameInput  = document.getElementById('username');
    const amountInput    = document.getElementById('amount');
    const buyBtn         = document.getElementById('buyBtn');
    const packagesEl     = document.getElementById('packages');
    const toggleBtn      = document.getElementById('toggleOptions');
    const photoEl        = document.getElementById('recipient-photo');
    const nameEl         = document.getElementById('recipient-name');
    const priceEl        = document.getElementById('amount-price');
    const priceContainer = document.getElementById('amount-price-container');
    const errorMsg       = document.getElementById('error-msg');

    let recipientId     = '';
    let selectedStars   = null;
    let isExpanded      = false;

    // === DATA ===
    const packagesData = [50,75,100,150,250,350,500,750,1000,1500,2500,5000,10000,25000,35000,50000,100000,150000,500000,1000000];
    const defaultSet = [50,500,2500];

    // === HELPERS ===
    function fmt(num) {
      return num.toLocaleString('en-US', {minimumFractionDigits:4});
    }
    function clearInput(id) {
      const el = document.getElementById(id);
      el.value = '';
      if (id==='username') {
        recipientId = ''; photoEl.style.display='none'; nameEl.style.display='none';
      } else {
        priceContainer.style.display='none';
      }
      el.focus(); updateBuyBtn();
    }

    // === RENDER PACKAGES ===
    function render(list) {
      packagesEl.innerHTML = '';
      list.forEach(n => {
        const div = document.createElement('div');
        div.className = 'package' + (selectedStars===n ? ' selected' : '');
        div.innerHTML = `
          <div class="left">
            <div class="checkbox"></div>
            <div class="stars">
              <img src="star.svg" alt=""/><img src="star.svg" alt=""/><img src="star.svg" alt=""/>
            </div>
            <span>${n.toLocaleString()} Stars</span>
          </div>
          <div class="price">
            <img src="ton.svg" class="ton-logo" alt="TON"/>
            <span>${fmt(packagesData.find(x=>x===n)*0.004752)}</span>
          </div>`;
        div.onclick = () => {
          selectedStars = n;
          amountInput.value = '';
          priceContainer.style.display = 'none';
          updateBuyBtn();
          render(isExpanded ? packagesData : defaultSet);
        };
        packagesEl.appendChild(div);
      });
    }

    // === FETCH RECIPIENT ===
    async function fetchRecipient() {
      const res = await fetch('/api/recipient', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username: usernameInput.value.trim()})
      });
      const data = await res.json();
      if(data.ok) {
        recipientId = data.recipient;
        photoEl.src = data.photo; photoEl.style.display='block';
        nameEl.textContent = data.name; nameEl.style.display='inline';
      } else {
        recipientId=''; photoEl.style.display='none'; nameEl.style.display='none';
      }
      updateBuyBtn();
    }

    // === FETCH PRICE ===
    async function fetchPrice(q) {
      if(!recipientId) return null;
      const res = await fetch('/api/price', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({recipient:recipientId,quantity:q})
      });
      const data = await res.json();
      return data.ok ? data.amount : null;
    }

    // === UPDATE BUY BUTTON ===
    async function updateBuyBtn() {
      const user  = usernameInput.value.trim();
      const qty   = parseInt(amountInput.value);
      let label   = selectedStars
        ? `Buy ${selectedStars.toLocaleString()} Stars`
        : (!isNaN(qty) ? `Buy ${qty.toLocaleString()} Stars` : 'Buy Stars');

      buyBtn.textContent = label;

      const validQty = selectedStars || (qty>=50 && qty<=1000000);
      const enabled  = isWalletConnected && user && validQty;
      buyBtn.classList.toggle('enabled', enabled);
      buyBtn.disabled = !enabled;
    }

    // === VALIDATE & PRICE ON INPUT ===
    amountInput.addEventListener('input', async () => {
      const val = parseInt(amountInput.value);
      selectedStars = null;
      errorMsg.textContent = '';
      if (isNaN(val)) return updateBuyBtn();
      if (val < 50) errorMsg.textContent = 'Min 50 stars';
      if (val > 1000000) errorMsg.textContent = 'Max 1 000 000 stars';
      if (!errorMsg.textContent && recipientId) {
        const p = await fetchPrice(val);
        if (p) {
          priceEl.textContent = p.toLocaleString('en-US', {minimumFractionDigits:4});
          priceContainer.style.display = 'flex';
        }
      }
      updateBuyBtn();
    });
    usernameInput.addEventListener('blur', fetchRecipient);

    // === TOGGLE PACKAGES ===
    toggleBtn.onclick = () => {
      isExpanded = !isExpanded;
      render(isExpanded ? packagesData : defaultSet);
      toggleBtn.textContent = isExpanded
        ? 'Hide More Options ▲'
        : 'Show More Options ▼';
    };

    window.addEventListener('resize', () => {
      render(isExpanded ? packagesData : defaultSet);
    });

    // === INITIALIZE ===
    render(defaultSet);
  </script>
</body>
</html>
