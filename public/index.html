<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUST_IO</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@600&family=Anton&display=swap" rel="stylesheet">

  <!-- Manifest TON Connect -->
  <link rel="manifest" href="/tonconnect-manifest.json">
  <!-- TON Connect UI SDK -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js" defer></script>

  <style>
    :root {
      --primary: #1A2026;
      --header: #212932;
      --card: #242E38;
      --blue: #0096F3;
      --white: #ffffff;
      --gray: #6c7380;
      --lightgray: #a3a9b4;
      --error: #e74c3c;
      --disabled: #0096F3;
    }
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family: 'Rubik', sans-serif; background: var(--primary); color: var(--white) }
    .error-text { color: var(--error); font-size: 13px; margin-top: 4px }

    header { background: var(--header); padding:12px; display:flex; justify-content:space-between; align-items:center }
    .logo-title { display:flex; align-items:center; gap:8px }
    .logo-title img { width:50px; height:50px }
    .logo-title h1 { font-family: 'Anton'; font-size:28px }
    .ton-connect { background:transparent; border:none; padding:8px 12px; border-radius:8px; color:#fff; cursor:pointer }

    .container {
      width: 100%;
      max-width: 500px;
      margin: 24px auto;
      padding: 0 16px;
    }
    @media (max-width: 600px) {
      .container { max-width: 85%; }
    }

    .intro { text-align:center; margin-bottom:24px }
    .intro h2 { font-size:26px; display:flex; justify-content:center; align-items:center; gap:10px }
    .intro p { color:var(--lightgray); font-size:15px; margin-top:6px }
    .link-history { display:block; text-align:center; margin-top:16px; font-size:14px; color:var(--blue); text-decoration:none }

    label { display:block; margin:16px 0 8px; color:var(--lightgray); font-size:14px }

    .input-wrapper { position:relative; margin-bottom:8px }
    .input-wrapper img.icon { position:absolute; top:50%; left:12px; width:25px; height:25px; transform:translateY(-50%) }
    .input-wrapper img.avatar { position:absolute; top:50%; left:12px; width:32px; height:32px; border-radius:50%; transform:translateY(-50%); display:none }

    input[type="text"], input[type="number"] {
      width:100%; padding:18px 44px; background:var(--card); border:none; border-radius:8px;
      color:var(--white); font-size:16px; outline:none;
    }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0 }
    input[type=number] { -moz-appearance: textfield }

    .clear-icon {
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      font-size:18px; color:var(--lightgray); cursor:pointer; display:none;
    }
    input:not(:placeholder-shown) ~ .clear-icon { display:block }

    .price-inline {
      display:flex; align-items:center; gap:6px;
      position:absolute; top:50%; right:44px; transform:translateY(-50%); display:none;
    }
    .price-inline .ton-logo { width:16px; height:16px }

    .btn-buy {
      background:var(--disabled); border:none; padding:16px; width:100%; height:50px;
      margin-top:24px; font-weight:bold; border-radius:12px; color:rgb(179,179,179);
      cursor:not-allowed; font-size:16px;
    }
    .btn-buy.enabled {
      background:var(--blue); color:var(--white); cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-title">
      <img src="logo.png" alt="Logo">
      <h1>DUST_IO</h1>
    </div>
    <button id="ton-connect" class="ton-connect"></button>
  </header>

  <div class="container">
    <div class="intro">
      <h2>Buy Telegram Stars <img src="star.svg" alt="star" style="width:26px"/></h2>
      <p>Top up Stars Balance for yourself or your friends.</p>
    </div>

    <label for="username">Recipient</label>
    <div class="input-wrapper">
      <img id="username-icon" src="Search.svg" class="icon" alt="icon"/>
      <img id="avatar" class="avatar" alt="avatar" />
      <input type="text" id="username" placeholder="Telegram username" />
      <div class="clear-icon" onclick="clearInput('username')">×</div>
    </div>
    <div id="user-error" class="error-text"></div>

    <label for="amount">Quantity</label>
    <div class="input-wrapper">
      <img src="star.svg" class="icon" alt="icon"/>
      <input type="number" id="amount" placeholder="Amount from 50 to 1,000,000" />
      <div class="clear-icon" onclick="clearInput('amount')">×</div>
      <div class="price-inline" id="amount-price-container">
        <img src="ton.svg" class="ton-logo" alt="TON"/>
        <span id="amount-price"></span>
      </div>
    </div>
    <div id="amount-error" class="error-text"></div>

    <button class="btn-buy" id="buyBtn">Buy Stars</button>
    <a class="link-history" href="#">View Transaction History</a>
  </div>

  <!-- после вашего существующего кода в body -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const ton = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: window.location.origin + '/tonconnect-manifest.json',
        buttonRootId: 'ton-connect'
      });
      let walletConnected = false;
      ton.onStatusChange(() => {
        walletConnected = ton.connected;
        updateBuyBtn();
      });

      const usernameEl  = document.getElementById('username');
      const amountEl    = document.getElementById('amount');
      const buyBtn      = document.getElementById('buyBtn');
      const priceSpan   = document.getElementById('amount-price');
      const priceInline = document.getElementById('amount-price-container');
      let recipientId   = '';

      // при вводе количества и пустом получателе — ждём выбора пользователя
      amountEl.addEventListener('input', () => {
        refreshButtonLabel();
      });

      // при потере фокуса по username
      usernameEl.addEventListener('blur', async () => {
        const u = usernameEl.value.trim();
        if (!u) return;
        // ...существующая логика поиска и показа аватара...
        // после успешной установки recipientId:
        // если количество уже введено — триггерим его заново
        if (amountEl.value) {
          amountEl.dispatchEvent(new Event('input'));
        }
      });

      // Обновляем текст на кнопке
      function refreshButtonLabel() {
        const v = parseInt(amountEl.value, 10);
        if (v >= 50 && v <= 1000000) {
          buyBtn.textContent = `Buy ${v} Stars`;
        } else {
          buyBtn.textContent = 'Buy Stars';
        }
      }

      // Клик по кнопке «Buy X Stars»
      buyBtn.addEventListener('click', async () => {
        if (!walletConnected || !recipientId) return;
        const qty = parseInt(amountEl.value, 10);
        if (!(qty >= 50 && qty <= 1000000)) return;

        // 1) Запрашиваем у нашего сервера параметры транзакции
        const r = await fetch('/api/buy', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ recipient: recipientId, quantity: qty })
        });
        const j = await r.json();
        if (!j.ok) {
          return alert('Ошибка создания транзакции: ' + j.error);
        }

        // 2) Формируем и отправляем транзакцию через TON Connect
        const tx = {
          validUntil: j.validUntil,
          messages: [{
            address: j.address,
            amount: j.amount,      // уже в nanotons, строкой
            payload: j.payload     // base64
          }]
        };
        try {
          await ton.sendTransaction(tx);
          alert('Транзакция отправлена в кошелёк!');
        } catch (e) {
          console.error(e);
          alert('Ошибка при отправке транзакции: ' + e.message);
        }
      });

      function updateBuyBtn() {
        const okQty = parseInt(amountEl.value,10) >= 50 && parseInt(amountEl.value,10) <= 1000000;
        buyBtn.disabled = !(walletConnected && recipientId && okQty);
      }

      // Первичная установка
      refreshButtonLabel();
      updateBuyBtn();
    });
  </script>
</body>
</html>
