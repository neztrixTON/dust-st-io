<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DUST_IO Stars Shop</title>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Rubik:wght@600&family=Anton&display=swap"
    rel="stylesheet"
  />

  <!-- Manifest для TON Connect -->
  <link rel="manifest" href="/tonconnect-manifest.json" />

  <!-- TON Connect UI SDK -->
  <script
    src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"
    defer
  ></script>

  <style>
    :root { --primary:#1A2026; --header:#212932; --card:#242E38; --blue:#0096F3; --white:#fff; --gray:#6c7380; --lightgray:#a3a9b4; --error:#e74c3c; --disabled:#555; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Rubik',sans-serif; background:var(--primary); color:var(--white); }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    header{background:var(--header);padding:12px;}
    .header-top{display:flex;justify-content:space-between;align-items:center;}
    .logo-title{display:flex;align-items:center;gap:8px;}
    .logo-title img{width:50px;height:50px;}
    .logo-title h1{font-family:'Anton';font-size:28px;}
    #ton-connect{background:rgba(0, 0, 255, 0);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer;}
    .container{max-width:900px;margin:24px auto;padding:0 16px;}
    label, .section-title{display:block;margin:16px 0 8px;color:var(--lightgray);}
    .input-wrapper{position:relative;margin-bottom:12px;}
    .input-wrapper img.icon{position:absolute;top:50%;left:12px;width:24px;height:24px;transform:translateY(-50%);}
    input{width:100%;padding:12px 44px;border:none;border-radius:8px;background:var(--card);color:#fff;}
    .clear-icon{position:absolute;top:50%;right:12px;transform:translateY(-50%);cursor:pointer;color:var(--lightgray);display:none;}
    input:not(:placeholder-shown)+.clear-icon{display:block;}
    .recipient-photo{position:absolute;top:50%;left:36px;width:24px;height:24px;border-radius:50%;transform:translateY(-50%);display:none;}
    .recipient-name{position:absolute;top:50%;left:68px;transform:translateY(-50%);display:none;color:#fff;}
    .price-inline{position:absolute;top:50%;right:36px;transform:translateY(-50%);display:none;align-items:center;gap:4px;}
    .price-inline img{width:16px;height:16px;}
    .package-list{margin:16px 0;display:grid;grid-template-columns:1fr;gap:12px;}
    .package{background:var(--card);padding:12px;display:flex;justify-content:space-between;align-items:center;border:2px solid transparent;border-radius:8px;cursor:pointer;}
    .package.selected{border-color:var(--blue);}
    .left{display:flex;align-items:center;gap:8px;}
    .checkbox{width:20px;height:20px;border:2px solid var(--gray);border-radius:50%;position:relative;}
    .checkbox::after{content:'';position:absolute;top:3px;left:3px;width:10px;height:10px;border-radius:50%;background:var(--blue);display:none;}
    .package.selected .checkbox::after{display:block;}
    .stars img{width:20px;height:20px;margin-left:-8px;}
    .price{display:flex;align-items:center;gap:4px;}
    #buyBtn{margin:16px 0;width:100%;padding:12px;font-weight:bold;border:none;border-radius:8px;background:var(--disabled);color:#888;cursor:not-allowed;}
    #buyBtn.enabled{background:var(--blue);color:#fff;cursor:pointer;}
    .show-options{margin:12px 0;padding:10px;background:var(--card);text-align:center;cursor:pointer;color:var(--blue);}
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="logo-title">
        <img src="logo.png" alt="Logo">
        <h1>DUST_IO</h1>
      </div>
      <button id="ton-connect"></button>
    </div>
  </header>

  <div class="container">
    <h2>Buy Telegram Stars</h2>

    <label for="username">Recipient</label>
    <div class="input-wrapper" id="username-wrapper">
      <img src="Search.svg" class="icon">
      <input type="text" id="username" placeholder="Telegram username">
      <img id="recipient-photo" class="recipient-photo">
      <span id="recipient-name" class="recipient-name"></span>
      <div class="clear-icon" onclick="clearInput('username')">×</div>
    </div>
    <div id="error-recipient" style="color:var(--error);font-size:13px;"></div>

    <label for="amount">Quantity</label>
    <div class="input-wrapper">
      <img src="star.svg" class="icon">
      <input type="number" id="amount" placeholder="50–1 000 000">
      <div class="price-inline" id="amount-price">
        <img src="ton.svg">
        <span></span>
      </div>
      <div class="clear-icon" onclick="clearInput('amount')">×</div>
    </div>
    <div id="error-amount" style="color:var(--error);font-size:13px;"></div>

    <div class="section-title">Or select a package</div>
    <div class="package-list" id="packages"></div>
    <div class="show-options" id="toggleOptions">Show More Options ▼</div>

    <button id="buyBtn">Buy Stars</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // TON Connect
      const ton = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: '/tonconnect-manifest.json',
        buttonRootId: 'ton-connect'
      });
      let walletConnected = false;
      ton.onStatusChange(() => {
        walletConnected = ton.connected;
        updateBuyBtn();
      });

      // Elements
      const usernameEl = document.getElementById('username');
      const wrapperEl  = document.getElementById('username-wrapper');
      const photoEl    = document.getElementById('recipient-photo');
      const nameEl     = document.getElementById('recipient-name');
      const errRec     = document.getElementById('error-recipient');

      const amountEl   = document.getElementById('amount');
      const priceInline= document.getElementById('amount-price');
      const priceSpan  = priceInline.querySelector('span');
      const errAmt     = document.getElementById('error-amount');

      const packagesEl = document.getElementById('packages');
      const toggleBtn  = document.getElementById('toggleOptions');
      const buyBtn     = document.getElementById('buyBtn');

      let recipientId = '';
      let selectedStars = null;
      let expanded = false;
      let pkgList = [50,75,100,150,250,350,500,750,1000,1500,2500,5000,10000,25000,35000,50000,100000,150000,500000,1000000];
      let pkgPrices = {};

      // Helpers
      const fmt = v=>(+v).toLocaleString('en-US',{minimumFractionDigits:4});

      window.clearInput = id=>{
        if(id==='username'){
          usernameEl.value=''; recipientId=''; photoEl.style.display='none'; nameEl.style.display='none'; wrapperEl.style.display='block'; errRec.textContent='';
        } else {
          amountEl.value=''; priceInline.style.display='none'; errAmt.textContent='';
        }
        updateBuyBtn();
      };

      // Fetch all package prices once
      (async ()=>{
        const arr = await Promise.all(pkgList.map(async stars=>{
          const resp = await fetch('/api/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({recipient:'',quantity:stars})});
          const j = await resp.json();
          return [stars, j.ok? j.amount/1e9 : 0];
        }));
        arr.forEach(([s,p])=>pkgPrices[s]=p);
        renderPackages();
      })();

      function renderPackages(){
        packagesEl.innerHTML='';
        const list = expanded ? pkgList : [50,500,2500];
        list.forEach(s=>{
          const p = pkgPrices[s]||0;
          const div = document.createElement('div');
          div.className='package'+(selectedStars===s?' selected':'');
          div.innerHTML=`
            <div class="left">
              <div class="checkbox"></div>
              <div class="stars"><img src="star.svg"/><img src="star.svg"/><img src="star.svg"/></div>
              <span>${s.toLocaleString()} Stars</span>
            </div>
            <div class="price"><img src="ton.svg"/><span>${fmt(p)}</span></div>`;
          div.onclick=()=>{
            selectedStars=s; amountEl.value=''; priceInline.style.display='none'; updateBuyBtn(); renderPackages();
          };
          packagesEl.appendChild(div);
        });
        toggleBtn.textContent=expanded?'Hide More Options ▲':'Show More Options ▼';
      }

      // Recipient lookup
      usernameEl.addEventListener('blur', async ()=>{
        const u = usernameEl.value.trim();
        if(!u) return;
        const res = await fetch('/api/recipient',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:u})});
        const j = await res.json();
        if(j.ok){
          recipientId=j.recipient;
          photoEl.src=j.photo; photoEl.style.display='block';
          nameEl.textContent=j.name; nameEl.style.display='inline';
          wrapperEl.style.display='none'; errRec.textContent='';
        } else {
          errRec.textContent='Пользователь не найден';
        }
        updateBuyBtn();
      });

      // Amount input
      amountEl.addEventListener('input', async ()=>{
        selectedStars=null; errAmt.textContent='';
        const v = parseInt(amountEl.value);
        if(isNaN(v)||v<50||v>1000000){
          if(v<50) errAmt.textContent='Мин. 50 stars';
          if(v>1000000) errAmt.textContent='Макс. 1 000 000 stars';
          priceInline.style.display='none';
          return updateBuyBtn();
        }
        if(recipientId){
          const res=await fetch('/api/price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({recipient:recipientId,quantity:v})});
          const j=await res.json();
          if(j.ok){
            priceSpan.textContent=fmt(j.amount/1e9);
            priceInline.style.display='flex';
          }
        }
        updateBuyBtn();
      });

      toggleBtn.onclick=()=>{
        expanded=!expanded; renderPackages();
      };

      function updateBuyBtn(){
        const uOk = !!recipientId;
        const a = parseInt(amountEl.value);
        const qOk = !!selectedStars || (!isNaN(a)&&a>=50&&a<=1000000);
        const en = walletConnected && uOk && qOk;
        buyBtn.disabled=!en;
        buyBtn.classList.toggle('enabled',en);
      }
    });
  </script>
</body>
</html>
