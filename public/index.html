<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUST_IO</title>

  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@600&family=Anton&display=swap" rel="stylesheet">

  <!-- Manifest для TON Connect (исправлено 404) -->
  <link rel="manifest" href="/tonconnect-manifest.json">

  <!-- TON Connect UI SDK -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js" defer></script>

  <style>
    :root {
      --primary: #1A2026;
      --header: #212932;
      --card: #242E38;
      --blue: #0096F3;
      --white: #ffffff;
      --gray: #6c7380;
      --lightgray: #a3a9b4;
      --error: #e74c3c;
      --disabled: #0096F3;
    }
    * { box-sizing: border-box; margin:0; padding:0 }
    body { font-family: 'Rubik', sans-serif; background: var(--primary); color: var(--white) }
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0 }
    input[type=number] { -moz-appearance: textfield }

    /* Recipient photo & name */
    .recipient-photo {
      position: absolute; top:50%; left:36px; transform:translateY(-50%);
      width:24px; height:24px; border-radius:50%; display:none;
    }
    .recipient-name {
      position: absolute; top:50%; left:68px; transform:translateY(-50%);
      color: var(--white); font-size:14px; display:none;
    }
    /* Inline amount price */
    .price-inline {
      display: flex; align-items: center; gap:6px; padding-right:12px;
      position: absolute; top:50%; right:36px; transform:translateY(-50%); display:none;
    }
    .price-inline .ton-logo { width:16px; height:16px }

    /* пакеты: gap между иконкой и цифрой */
    .package .price {
      display: flex; align-items: center; gap:6px;
    }

    h1 { font-family: 'Anton', sans-serif; font-size:30px; letter-spacing:1px }
    header { background: var(--header); padding:12px; display:flex; justify-content:space-between; align-items:center }
    .logo-title { display:flex; align-items:center; gap:8px }
    .logo-title img { width:50px; height:50px }
    .logo-title h1 { font-size:28px }
    .ton-connect { background:rgba(255, 255, 255, 0); border:none; padding:8px 12px; border-radius:8px; color:#fff; cursor:pointer }
    .container { max-width:900px; margin:24px auto; padding:0 16px }
    .intro { text-align:center; margin-bottom:24px }
    .intro h2 { font-size:26px; display:flex; justify-content:center; align-items:center; gap:10px }
    .intro p { color:var(--lightgray); font-size:15px; margin-top:6px }
    .link-history { display: block; text-align: center; margin-top: 16px; font-size: 14px; color: var(--blue); text-decoration: none; }

    label, .section-title { display:block; margin:16px 0 8px; color:var(--lightgray); font-size:14px }
    .input-wrapper { position:relative; margin-bottom:12px }
    .input-wrapper img.icon { position:absolute; top:50%; left:12px; width:25px; height:25px; transform:translateY(-50%) }
    input[type="text"], input[type="number"] {
      width:100%; padding:12px 44px; background:var(--card); border:none; border-radius:8px;
      color:var(--white); font-size:16px; outline:none;
    }
    .clear-icon {
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      font-size:18px; color:var(--lightgray); cursor:pointer; display:none;
    }
    input:not(:placeholder-shown) ~ .clear-icon { display:block }

    .package-list { margin-top:24px; display:flex; flex-direction:column; gap:14px }
    .package {
      background:var(--card); border:2px solid transparent; border-radius:12px;
      padding:18px 20px; display:flex; align-items:center; justify-content:space-between;
      cursor:pointer; transition:0.3s;
    }
    .package.selected { border-color:var(--blue) }
    .left { display:flex; align-items:center; gap:14px }
    .checkbox {
      width:20px; height:20px; border:2px solid var(--gray); border-radius:50%; position:relative;
    }
    .checkbox::after {
      content:""; width:10px; height:10px; background:var(--blue);
      border-radius:50%; position:absolute; top:3px; left:3px; display:none;
    }
    .package.selected .checkbox::after { display:block }

    .stars { display:flex; margin-right:8px }
    .stars img {
      width:20px; height:20px; margin-left:-25px;
      filter:drop-shadow(1px 0 3px rgb(0,0,0));
    }
    .stars img:first-child { margin-left:5px }

    .btn-buy {
      background:var(--disabled); border:none; padding:16px; width:100%; height:50px;
      margin-top:24px; font-weight:bold; border-radius:12px; color:rgb(179,179,179);
      cursor:not-allowed; font-size:16px;
    }
    .btn-buy.enabled {
      background:var(--blue); color:var(--white); cursor:pointer;
    }

    .show-options {
      background:var(--card); border-radius:10px; text-align:center; padding:20px;
      height:55px; margin-top:20px; font-weight:500; font-size:15px; color:var(--blue);
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-title">
      <img src="logo.png" alt="Logo"><h1>DUST_IO</h1>
    </div>
    <button id="ton-connect" class="ton-connect"></button>
  </header>

  <div class="container">
    <div class="intro">
      <h2>Buy Telegram Stars <img src="star.svg" alt="star" style="width:26px"/></h2>
      <p>Top up Stars Balance for yourself or your friends and colleagues.</p>
    </div>

    <label for="username">Recipient</label>
    <div class="input-wrapper">
      <img src="Search.svg" class="icon"/>
      <input type="text" id="username" placeholder="Telegram username"/>
      <img id="recipient-photo" class="recipient-photo" alt="recipient photo"/>
      <span id="recipient-name" class="recipient-name"></span>
      <div class="clear-icon" onclick="clearInput('username')">×</div>
    </div>
    <div id="error-msg" class="error-text"></div>

    <label for="amount">Quantity</label>
    <div class="input-wrapper">
      <img src="star.svg" class="icon"/>
      <input type="number" id="amount" placeholder="Amount from 50 to 1,000,000"/>
      <div class="price-inline" id="amount-price-container">
        <img src="ton.svg" class="ton-logo" alt="TON"/>
        <span id="amount-price"></span>
      </div>
      <div class="clear-icon" onclick="clearInput('amount')">×</div>
    </div>

    <p class="section-title">Or select a package</p>
    <div class="package-list" id="packages"></div>
    <div class="show-options" id="toggleOptions">Show More Options ▼</div>

    <button class="btn-buy" id="buyBtn">Buy Stars</button>
    <a class="link-history" href="#">View Transaction History</a>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // === TON Connect UI init ===
    const ton = new TON_CONNECT_UI.TonConnectUI({
      manifestUrl: '/tonconnect-manifest.json',
      buttonRootId: 'ton-connect'
    });
    let walletConnected = false;
    ton.onStatusChange(() => {
      walletConnected = ton.connected;
      updateBuyBtn();
    });

    // === Elements ===
    const usernameEl    = document.getElementById('username');
    const photoEl       = document.getElementById('recipient-photo');
    const nameEl        = document.getElementById('recipient-name');
    const clearUserEl   = document.querySelector('#username ~ .clear-icon');
    const amountEl      = document.getElementById('amount');
    const priceInline   = document.getElementById('amount-price-container');
    const priceSpan     = document.getElementById('amount-price');
    const pkgListEl     = document.getElementById('packages');
    const toggleBtn     = document.getElementById('toggleOptions');
    const buyBtn        = document.getElementById('buyBtn');
    const errorMsg      = document.getElementById('error-msg');

    let recipientId    = '';
    let selectedStars  = null;
    let expanded       = false;
    const pkgCounts    = [50,75,100,150,250,350,500,750,1000,1500,2500,5000,10000,25000,35000,50000,100000,150000,500000,1000000];
    const pkgPrices    = {};
    const DEFAULT_USER = 'b77so';

    const fmt = v => (+v).toLocaleString('en-US',{minimumFractionDigits:4});

    // Clear inputs
    window.clearInput = id => {
      if (id==='username') {
        usernameEl.disabled = false;
        usernameEl.value = '';
        recipientId = '';
        photoEl.style.display='none';
        nameEl.style.display='none';
        errorMsg.textContent = '';
      } else {
        amountEl.value = '';
        priceInline.style.display='none';
        errorMsg.textContent = '';
      }
      updateBuyBtn();
    };

    // 1) Получаем default recipient для пакетов
    async function initDefaultRecipient() {
      const res = await fetch('/api/recipient',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ username: DEFAULT_USER })
      });
      const j = await res.json();
      return j.ok ? j.recipient : '';
    }

    // 2) Подгружаем цены пакетов (нанотоны → TON)
    async function loadPackagePrices(defaultRec) {
      if (!defaultRec) return;
      await Promise.all(pkgCounts.map(q =>
        fetch('/api/price',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ recipient: defaultRec, quantity: q })
        })
        .then(r => r.json())
        .then(j => pkgPrices[q] = j.ok? j.amount/1e9 : 0)
      ));
      renderPackages();
    }

    // Рендер пакетов
    function renderPackages() {
      pkgListEl.innerHTML = '';
      const list = expanded ? pkgCounts : [50,500,2500];
      list.forEach(stars => {
        const price = pkgPrices[stars]||0;
        const div = document.createElement('div');
        div.className = 'package'+(selectedStars===stars?' selected':'');
        div.innerHTML = `
          <div class="left">
            <div class="checkbox"></div>
            <div class="stars"><img src="star.svg"/><img src="star.svg"/><img src="star.svg"/></div>
            <span>${stars.toLocaleString()} Stars</span>
          </div>
          <div class="price">
            <img src="ton.svg" class="ton-logo"/><span>${fmt(price)}</span>
          </div>`;
        div.onclick = () => {
          selectedStars = stars;
          amountEl.value = '';
          priceInline.style.display='none';
          updateBuyBtn();
          renderPackages();
        };
        pkgListEl.appendChild(div);
      });
      toggleBtn.textContent = expanded?'Hide More Options ▲':'Show More Options ▼';
    }

    // Инициализация пакетов
    initDefaultRecipient().then(initRec => loadPackagePrices(initRec));

    // blur username → вставляем name, avatar, блокируем input
    usernameEl.addEventListener('blur', async () => {
      const u = usernameEl.value.trim();
      if (!u) return;
      const res = await fetch('/api/recipient',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ username: u })
      });
      const j = await res.json();
      if (j.ok) {
        recipientId = j.recipient;
        usernameEl.value = j.name;
        usernameEl.disabled = true;
        photoEl.src = j.photo; photoEl.style.display = 'block';
        nameEl.textContent = j.name; nameEl.style.display = 'inline';
        clearUserEl.style.display = 'block';
      } else {
        errorMsg.textContent = 'Пользователь не найден';
      } 
      updateBuyBtn();
    });

    // input amount → fetch price and show in TON
    amountEl.addEventListener('input', async () => {
      selectedStars = null;
      errorMsg.textContent = '';
      const v = parseInt(amountEl.value,10);
      if (isNaN(v)||v<50||v>1000000) {
        if (v<50) errorMsg.textContent='Мин. 50 stars';
        if (v>1000000) errorMsg.textContent='Макс. 1 000 000 stars';
        priceInline.style.display='none';
        return updateBuyBtn();
      }
      if (recipientId) {
        const r = await fetch('/api/price',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ recipient: recipientId, quantity: v })
        });
        const d = await r.json();
        if (d.ok) {
          priceSpan.textContent = fmt(d.amount/1e9);
          priceInline.style.display = 'flex';
        }
      }
      updateBuyBtn();
    });

    toggleBtn.onclick = () => {
      expanded = !expanded;
      renderPackages();
    };
    window.addEventListener('resize', renderPackages);

    function updateBuyBtn() {
      const okQty = selectedStars || (+amountEl.value>=50 && +amountEl.value<=1000000);
      const okUsr = !!recipientId;
      const en = walletConnected && okUsr && okQty;
      buyBtn.disabled = !en;
      buyBtn.classList.toggle('enabled', en);
    }

    // первый рендер
    renderPackages();
    updateBuyBtn();
  });
  </script>
</body>
</html>
